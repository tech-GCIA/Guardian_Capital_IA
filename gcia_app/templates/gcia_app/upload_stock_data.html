{% extends 'gcia_app/base.html' %}

{% block title %}Upload Stock Data{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Upload Stock Data</h1>
                
                <!-- Display Toast Notifications -->
                {% if messages %}
                    <div id="toast-container">
                        {% for message in messages %}
                            <div class="toast {{ message.tags }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Upload Form Card -->
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>
                            Upload App-Base Sheet
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data" action="{% url 'upload_stock_data' %}" id="uploadForm">
                            {% csrf_token %}
                            
                            <div class="mb-3">
                                <label for="{{ form.excel_file.id_for_label }}" class="form-label">
                                    {{ form.excel_file.label }}
                                </label>
                                {{ form.excel_file }}
                                {% if form.excel_file.help_text %}
                                    <div class="form-text">{{ form.excel_file.help_text }}</div>
                                {% endif %}
                                {% if form.excel_file.errors %}
                                    <div class="text-danger">
                                        {% for error in form.excel_file.errors %}
                                            <small>{{ error }}</small><br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>
                                    Upload and Process
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg ms-2" style="display: none;" id="processingBtn" disabled>
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    Processing...
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Instructions Card -->
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Instructions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>File Requirements:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>Excel format (.xls, .xlsx, .xlsm)</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Maximum file size: 50MB</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Must contain App-Base Sheet</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>What happens after upload:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-cog text-primary me-2"></i>Parse stock data from Excel</li>
                                    <li><i class="fas fa-database text-primary me-2"></i>Update database with new stocks</li>
                                    <li><i class="fas fa-chart-line text-primary me-2"></i>Add quarterly financial data</li>
                                    <li><i class="fas fa-check-circle text-success me-2"></i>Show processing results</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Uploads -->
                {% if recent_uploads %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Uploads
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Filename</th>
                                        <th>Status</th>
                                        <th>Stocks Added</th>
                                        <th>Quarterly Records</th>
                                        <th>Processing Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for upload in recent_uploads %}
                                    <tr>
                                        <td>{{ upload.uploaded_at|date:"M d, Y H:i" }}</td>
                                        <td>{{ upload.filename }}</td>
                                        <td>
                                            {% if upload.status == 'completed' %}
                                                <span class="badge bg-success">{{ upload.status|title }}</span>
                                            {% elif upload.status == 'failed' %}
                                                <span class="badge bg-danger">{{ upload.status|title }}</span>
                                            {% elif upload.status == 'processing' %}
                                                <span class="badge bg-warning">{{ upload.status|title }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ upload.status|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ upload.stocks_added }}</td>
                                        <td>{{ upload.quarterly_records_added }}</td>
                                        <td>
                                            {% if upload.processing_time %}
                                                {{ upload.processing_time.total_seconds|floatformat:1 }}s
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Handle form submission
            const form = document.getElementById('uploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            const processingBtn = document.getElementById('processingBtn');
            
            form.addEventListener('submit', function(e) {
                // Show processing state
                uploadBtn.style.display = 'none';
                processingBtn.style.display = 'inline-block';
                
                // Disable form submission to prevent double-click
                uploadBtn.disabled = true;
            });

            // File input change handler
            const fileInput = document.getElementById('stockDataFile');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Basic file validation on frontend
                    const allowedExtensions = ['.xls', '.xlsx', '.xlsm'];
                    const fileName = file.name.toLowerCase();
                    const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
                    
                    if (!isValidExtension) {
                        alert('Please select a valid Excel file (.xls, .xlsx, .xlsm)');
                        e.target.value = '';
                        return;
                    }
                    
                    if (file.size > 50 * 1024 * 1024) { // 50MB
                        alert('File size too large. Please select a file smaller than 50MB.');
                        e.target.value = '';
                        return;
                    }
                }
            });

            // Toast fade-out functionality
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(toast => {
                setTimeout(function() {
                    toast.classList.add('fade');
                }, 5000);
                
                setTimeout(function() {
                    toast.remove();
                }, 6000);
            });
        });
    </script>

    <style>
        .toast {
            transition: opacity 1s ease-out;
        }
        
        .toast.fade {
            opacity: 0;
        }
        
        .card {
            border: none;
            border-radius: 10px;
        }
        
        .card-header {
            border-radius: 10px 10px 0 0 !important;
        }
        
        .form-control-file {
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background-color: #fff;
        }
        
        .form-control-file:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
{% endblock %}