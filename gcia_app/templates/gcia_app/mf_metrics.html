{% extends 'gcia_app/base.html' %}
{% load static %}

{% block title %}MF Metrics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Mutual Fund Metrics Management</h1>
            
            <!-- Last Calculation Summary Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Last Calculation Summary</h5>
                </div>
                <div class="card-body">
                    {% if last_calculation %}
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Date:</strong><br>
                                {{ last_calculation.started_at|date:"Y-m-d H:i" }}
                            </div>
                            <div class="col-md-2">
                                <strong>Status:</strong><br>
                                <span class="badge badge-{% if last_calculation.status == 'completed' %}success{% elif last_calculation.status == 'running' %}warning{% else %}danger{% endif %}">
                                    {{ last_calculation.get_status_display }}
                                </span>
                            </div>
                            <div class="col-md-2">
                                <strong>Funds Processed:</strong><br>
                                {{ last_calculation.funds_processed_successfully }}/{{ last_calculation.total_funds_targeted }}
                            </div>
                            <div class="col-md-2">
                                <strong>Partial Data:</strong><br>
                                {{ last_calculation.funds_with_partial_data }}
                            </div>
                            <div class="col-md-2">
                                <strong>Failed:</strong><br>
                                {{ last_calculation.funds_failed }}
                            </div>
                            <div class="col-md-1">
                                <strong>Duration:</strong><br>
                                {% if last_calculation.processing_duration %}
                                    {{ last_calculation.processing_duration|floatformat:1 }}s
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No calculations have been run yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Bulk Operations Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Bulk Metrics Calculation</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="mb-3">
                                Calculate portfolio metrics for all active mutual funds. This process analyzes 
                                underlying holdings and quarterly stock data to compute comprehensive portfolio metrics 
                                including TOTALS, PATM, QoQ/YoY growth, CAGR, PE ratios, and performance indicators.
                            </p>
                            <div class="alert alert-warning">
                                <strong>Note:</strong> This operation may take several minutes depending on the number of funds and data volume.
                            </div>
                        </div>
                        <div class="col-md-4 text-right">
                            <button 
                                type="button" 
                                class="btn btn-primary btn-lg" 
                                id="updateAllMetricsBtn" 
                                onclick="updateAllMetrics()"
                            >
                                <i class="fas fa-calculator me-2"></i>
                                Update All MF Metrics
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Bar (hidden initially) -->
                    <div id="calculationProgress" class="mt-3" style="display: none;">
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small id="progressText">Initializing calculation...</small>
                            <small id="progressStats">0/0 funds processed</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Analysis Download Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Portfolio Analysis Download</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="mb-3">
                                Download detailed Portfolio Analysis Excel report for individual mutual funds. 
                                The report includes holdings composition, quarterly data, and calculated metrics 
                                in the same format as the Old Bridge Focused Equity Fund analysis sheet.
                            </p>
                            
                            <div class="form-group">
                                <label for="fundSelect" class="form-label">Select Mutual Fund:</label>
                                <select id="fundSelect" class="form-control">
                                    <option value="">-- Select a Mutual Fund --</option>
                                    {% for fund in active_funds %}
                                    <option value="{{ fund.amcfundscheme_id }}" 
                                            data-name="{{ fund.name }}"
                                            data-holdings="{{ fund.holdings_count|default:0 }}">
                                        {{ fund.name }} 
                                        {% if fund.holdings_count %}({{ fund.holdings_count }} holdings){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 text-right">
                            <button 
                                type="button" 
                                class="btn btn-success btn-lg" 
                                id="downloadAnalysisBtn" 
                                onclick="downloadPortfolioAnalysis()"
                                disabled
                            >
                                <i class="fas fa-download me-2"></i>
                                Download Excel Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Summary Table -->
            {% if metrics_summary %}
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Recent Metrics Summary (Top 20 Funds)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fund Name</th>
                                    <th>Holdings</th>
                                    <th>Total Weightage</th>
                                    <th>Portfolio MCap (Cr)</th>
                                    <th>Current PE</th>
                                    <th>PAT (Cr)</th>
                                    <th>YoY Growth</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metric in metrics_summary %}
                                <tr>
                                    <td>
                                        <small>{{ metric.amcfundscheme.name|truncatechars:50 }}</small>
                                    </td>
                                    <td>{{ metric.total_holdings }}</td>
                                    <td>{{ metric.total_weightage|floatformat:1 }}%</td>
                                    <td>
                                        {% if metric.portfolio_market_cap %}
                                            {{ metric.portfolio_market_cap|floatformat:0 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if metric.portfolio_current_pe %}
                                            {{ metric.portfolio_current_pe|floatformat:2 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if metric.portfolio_pat %}
                                            {{ metric.portfolio_pat|floatformat:0 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if metric.portfolio_yoy_growth %}
                                            <span class="{% if metric.portfolio_yoy_growth > 0 %}text-success{% elif metric.portfolio_yoy_growth < 0 %}text-danger{% endif %}">
                                                {{ metric.portfolio_yoy_growth|floatformat:1 }}%
                                            </span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-{% if metric.calculation_status == 'success' %}success{% elif metric.calculation_status == 'partial' %}warning{% else %}danger{% endif %}">
                                            {{ metric.get_calculation_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ metric.last_updated|date:"M d, H:i" }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Alert Messages -->
            <div id="alerts" class="mt-4"></div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="loading-content">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" id="loadingMessage">Processing metrics calculation...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('MF Metrics page loaded');

// Global variables
let calculationInProgress = false;
let progressCheckInterval = null;

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Update All Metrics Function
function updateAllMetrics() {
    if (calculationInProgress) {
        showAlert('Calculation is already in progress. Please wait.', 'warning');
        return;
    }

    const confirmUpdate = confirm(
        'This will calculate metrics for all active mutual funds. ' +
        'The process may take several minutes. Do you want to continue?'
    );

    if (!confirmUpdate) return;

    calculationInProgress = true;
    
    // Update UI
    const updateBtn = document.getElementById('updateAllMetricsBtn');
    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating...';

    // Show progress
    document.getElementById('calculationProgress').style.display = 'block';
    document.getElementById('loadingOverlay').style.display = 'flex';

    // Start calculation
    fetch('/app/mf_metrics/update_all/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            force_recalculate: false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Start polling for progress
            progressCheckInterval = setInterval(checkCalculationProgress, 2000);
            showAlert('Metrics calculation started successfully!', 'success');
        } else {
            throw new Error(data.message || 'Failed to start calculation');
        }
    })
    .catch(error => {
        console.error('Error starting calculation:', error);
        showAlert(`Error starting calculation: ${error.message}`, 'error');
        resetCalculationUI();
    });
}

// Check calculation progress
function checkCalculationProgress() {
    fetch('/app/mf_metrics/progress/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        updateProgressUI(data);
        
        if (data.status === 'completed' || data.status === 'failed') {
            clearInterval(progressCheckInterval);
            calculationCompleted(data);
        }
    })
    .catch(error => {
        console.error('Error checking progress:', error);
        clearInterval(progressCheckInterval);
        resetCalculationUI();
    });
}

// Update progress UI
function updateProgressUI(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressStats = document.getElementById('progressStats');
    
    if (data.total_funds > 0) {
        const percentage = Math.round((data.processed_funds / data.total_funds) * 100);
        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';
        
        progressText.textContent = `Processing: ${data.current_fund || 'Preparing...'}`;
        progressStats.textContent = `${data.processed_funds}/${data.total_funds} funds processed`;
    }
}

// Calculation completed
function calculationCompleted(data) {
    calculationInProgress = false;
    
    if (data.status === 'completed') {
        showAlert(
            `Metrics calculation completed! Processed ${data.successful_funds} funds successfully. ` +
            `${data.partial_funds} with partial data, ${data.failed_funds} failed.`,
            'success'
        );
        
        // Refresh page to show updated data
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    } else {
        showAlert(`Calculation failed: ${data.error_message || 'Unknown error'}`, 'error');
    }
    
    resetCalculationUI();
}

// Reset calculation UI
function resetCalculationUI() {
    calculationInProgress = false;
    
    const updateBtn = document.getElementById('updateAllMetricsBtn');
    updateBtn.disabled = false;
    updateBtn.innerHTML = '<i class="fas fa-calculator me-2"></i>Update All MF Metrics';
    
    document.getElementById('calculationProgress').style.display = 'none';
    document.getElementById('loadingOverlay').style.display = 'none';
}


// Download Portfolio Analysis Function
function downloadPortfolioAnalysis() {
    const fundSelect = document.getElementById('fundSelect');
    const selectedFundId = fundSelect.value;
    const selectedOption = fundSelect.options[fundSelect.selectedIndex];
    
    if (!selectedFundId) {
        showAlert('Please select a mutual fund first.', 'warning');
        return;
    }
    
    const fundName = selectedOption.getAttribute('data-name');
    
    // Show loading
    const downloadBtn = document.getElementById('downloadAnalysisBtn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating Excel...';
    downloadBtn.disabled = true;
    
    // Generate and download Excel
    fetch('/app/mf_metrics/download_analysis/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            fund_id: selectedFundId
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to generate Excel report');
            });
        }
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Generate filename
        const safeFundName = fundName.replace(/[^a-zA-Z0-9\s\-_]/g, '').replace(/\s+/g, '_');
        const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `${safeFundName}_Portfolio_Analysis_${currentDate}.xlsx`;
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Clean up
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
        }, 100);
        
        showAlert(`Portfolio Analysis for "${fundName}" downloaded successfully!`, 'success');
    })
    .catch(error => {
        console.error('Error downloading analysis:', error);
        showAlert(`Error generating report: ${error.message}`, 'error');
    })
    .finally(() => {
        // Reset button
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
    });
}

// Fund selection change handler
document.addEventListener('DOMContentLoaded', function() {
    const fundSelect = document.getElementById('fundSelect');
    const downloadBtn = document.getElementById('downloadAnalysisBtn');
    
    if (fundSelect) {
        fundSelect.addEventListener('change', function() {
            downloadBtn.disabled = !this.value;
        });
    }
    
    // Page always starts fresh - no need to check previous calculation status
});

// Show alert function
function showAlert(message, type) {
    const alertsContainer = document.getElementById('alerts');
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    // Remove existing alerts of same type
    const existingAlerts = alertsContainer.querySelectorAll(`.alert-${type === 'error' ? 'danger' : type}`);
    existingAlerts.forEach(alert => alert.remove());
    
    alertsContainer.appendChild(alertDiv);
    
    // Auto remove after 10 seconds for success/info messages
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 10000);
    }
}

console.log('MF Metrics JavaScript initialized');
</script>

<style>
/* Custom styles for MF Metrics page */
.card {
    border: none;
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
    font-weight: 600;
}

.progress {
    height: 25px;
}

.progress-bar {
    font-size: 12px;
    line-height: 25px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    min-width: 250px;
}

.loading-content p {
    margin: 0;
    color: #666;
    font-size: 16px;
}

.table th, .table td {
    vertical-align: middle;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 16px;
}

.alert {
    border-radius: 8px;
    margin-bottom: 10px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    color: inherit;
}

.badge {
    font-size: 0.85em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .btn-lg {
        width: 100%;
        margin-top: 15px;
    }
    
    .table-responsive {
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}