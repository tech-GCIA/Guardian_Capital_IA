{% extends 'gcia_app/base.html' %}
{% load static %}

{% block title %}Fund Analysis{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Fund Analysis</h1>
            
            <!-- Fund Name Input -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="fundName" class="form-label">Fund Name</label>
                            <input type="text" id="fundName" class="form-control" placeholder="Enter Fund Name (e.g., Old Bridge Focused Equity Fund)" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selected Stocks Table -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Selected Stocks</h5>
                    <button type="button" class="btn btn-success" id="generateReportBtn" onclick="generateAndDownloadReport()">
                        <i class="fas fa-file-excel me-1"></i> Generate Excel Report
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Stock Name</th>
                                    <th>Weightage (%)</th>
                                    <th>Number of Shares</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="stocksTableBody">
                                <tr id="emptyRow">
                                    <td colspan="4" class="text-center text-muted py-4">
                                        No stocks selected. Use the form below to add stocks.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th>Total</th>
                                    <th id="totalWeightage">0.00%</th>
                                    <th id="totalStocks">0 stocks</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add Stock Form -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Add Stock to Portfolio</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="stockSelect" class="form-label">Stock</label>
                            <select id="stockSelect" class="form-control">
                                <option value="">-- Select a Stock --</option>
                                {% for stock in all_stocks %}
                                <option value="{{ stock.stock_id }}" 
                                        data-name="{{ stock.name }}" 
                                        data-symbol="{{ stock.symbol }}"
                                        data-sector="{{ stock.sector|default:'' }}">
                                    {{ stock.name }} ({{ stock.symbol }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="stockWeightage" class="form-label">Weightage (%)</label>
                            <input 
                                type="number" 
                                id="stockWeightage" 
                                class="form-control" 
                                placeholder="0.00" 
                                step="0.01" 
                                min="0.01" 
                                max="100.00"
                            />
                        </div>
                        <div class="col-md-3">
                            <label for="stockShares" class="form-label">Number of Shares</label>
                            <input 
                                type="number" 
                                id="stockShares" 
                                class="form-control" 
                                placeholder="0" 
                                min="1"
                            />
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" id="addStockBtn" onclick="addStock()">Add Stock</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Messages -->
            <div id="alerts" class="mt-4"></div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="display: none;">
                <div class="loading-content">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating Excel report...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript placed directly in the content block to ensure it loads -->
<script>
console.log('Fund Analysis JavaScript loaded');

// Global variables
let selectedStocks = [];

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
console.log('CSRF token:', csrftoken);

// Add stock function
function addStock() {
    console.log('Add stock button clicked');
    
    try {
        // Get form elements
        const stockSelect = document.getElementById('stockSelect');
        const weightageInput = document.getElementById('stockWeightage');
        const sharesInput = document.getElementById('stockShares');
        
        console.log('Form elements found:', {
            stockSelect: !!stockSelect,
            weightageInput: !!weightageInput,
            sharesInput: !!sharesInput
        });
        
        if (!stockSelect || !weightageInput || !sharesInput) {
            console.error('One or more form elements not found');
            showAlert('Form elements not found. Please refresh the page.', 'error');
            return;
        }
        
        // Get values
        const stockId = stockSelect.value;
        const selectedOption = stockSelect.options[stockSelect.selectedIndex];
        const stockName = selectedOption ? selectedOption.getAttribute('data-name') : '';
        const stockSymbol = selectedOption ? selectedOption.getAttribute('data-symbol') : '';
        const weightage = parseFloat(weightageInput.value);
        const shares = parseInt(sharesInput.value);
        
        console.log('Form values:', { stockId, stockName, stockSymbol, weightage, shares });
        
        // Validate
        if (!stockId) {
            showAlert('Please select a stock', 'warning');
            return;
        }
        
        if (!weightage || weightage <= 0 || weightage > 100) {
            showAlert('Please enter valid weightage (0.01 - 100)', 'warning');
            return;
        }
        
        if (!shares || shares <= 0) {
            showAlert('Please enter valid number of shares (minimum 1)', 'warning');
            return;
        }
        
        // Check if stock already exists
        const existingStock = selectedStocks.find(stock => stock.id === stockId);
        if (existingStock) {
            showAlert('Stock already added to portfolio', 'warning');
            return;
        }
        
        // Check total weightage
        const currentTotal = selectedStocks.reduce((sum, stock) => sum + stock.weightage, 0);
        if (currentTotal + weightage > 100) {
            showAlert(`Total weightage would exceed 100%. Current: ${currentTotal.toFixed(2)}%`, 'warning');
            return;
        }
        
        // Add stock to array
        const newStock = {
            id: stockId,
            name: stockName,
            symbol: stockSymbol,
            weightage: weightage,
            shares: shares
        };
        
        selectedStocks.push(newStock);
        console.log('Stock added:', newStock);
        console.log('Total stocks:', selectedStocks.length);
        
        // Update table
        updateTable();
        
        // Reset form
        stockSelect.value = '';
        weightageInput.value = '';
        sharesInput.value = '';
        
        // Show success message
        showAlert(`${stockName} added successfully!`, 'success');
        
    } catch (error) {
        console.error('Error in addStock function:', error);
        showAlert('An error occurred while adding the stock', 'error');
    }
}

// Update table function
function updateTable() {
    console.log('Updating table...');
    
    try {
        const tableBody = document.getElementById('stocksTableBody');
        const emptyRow = document.getElementById('emptyRow');
        const totalWeightageSpan = document.getElementById('totalWeightage');
        const totalStocksSpan = document.getElementById('totalStocks');
        
        if (!tableBody || !emptyRow || !totalWeightageSpan || !totalStocksSpan) {
            console.error('Table elements not found');
            return;
        }
        
        // Clear existing rows (except empty row)
        const existingRows = tableBody.querySelectorAll('tr:not(#emptyRow)');
        existingRows.forEach(row => row.remove());
        
        if (selectedStocks.length === 0) {
            // Show empty row
            emptyRow.style.display = '';
        } else {
            // Hide empty row
            emptyRow.style.display = 'none';
            
            // Add stock rows
            selectedStocks.forEach((stock, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stock.name} (${stock.symbol})</td>
                    <td>${stock.weightage.toFixed(2)}%</td>
                    <td>${stock.shares.toLocaleString()}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStock(${index})">
                            ×
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Update totals
        const totalWeightage = selectedStocks.reduce((sum, stock) => sum + stock.weightage, 0);
        const stockCount = selectedStocks.length;
        
        totalWeightageSpan.textContent = totalWeightage.toFixed(2) + '%';
        totalStocksSpan.textContent = stockCount + ' stock' + (stockCount !== 1 ? 's' : '');
        
        // Color code weightage
        if (totalWeightage > 100) {
            totalWeightageSpan.style.color = 'red';
        } else if (totalWeightage === 100) {
            totalWeightageSpan.style.color = 'green';
        } else {
            totalWeightageSpan.style.color = 'inherit';
        }
        
        console.log('Table updated. Total stocks:', stockCount, 'Total weightage:', totalWeightage.toFixed(2) + '%');
        
    } catch (error) {
        console.error('Error in updateTable function:', error);
    }
}

// Remove stock function
function removeStock(index) {
    console.log('Removing stock at index:', index);
    
    try {
        const removedStock = selectedStocks[index];
        selectedStocks.splice(index, 1);
        
        updateTable();
        showAlert(`${removedStock.name} removed from portfolio`, 'info');
    } catch (error) {
        console.error('Error in removeStock function:', error);
        showAlert('Error removing stock', 'error');
    }
}

// Update the generateAndDownloadReport function in your fund_analysis.html template

function generateAndDownloadReport() {
    console.log('Generate and download report clicked');
    
    const fundName = document.getElementById('fundName').value.trim();
    
    // Validate
    if (!fundName) {
        showAlert('Please enter a fund name', 'warning');
        return;
    }
    
    if (selectedStocks.length === 0) {
        showAlert('Please add at least one stock', 'warning');
        return;
    }
    
    const totalWeightage = selectedStocks.reduce((sum, stock) => sum + stock.weightage, 0);
    if (totalWeightage > 100) {
        showAlert(`Total weightage (${totalWeightage.toFixed(2)}%) cannot exceed 100%`, 'error');
        return;
    }
    
    if (totalWeightage <= 0) {
        showAlert('Total weightage must be greater than 0%', 'error');
        return;
    }
    
    // Show loading overlay
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Show loading state on button
    const generateBtn = document.getElementById('generateReportBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating Excel...';
    generateBtn.disabled = true;
    
    // Prepare data for Excel generation
    const requestData = {
        fund_name: fundName,
        selected_stocks: selectedStocks
    };
    
    console.log('Sending request data:', requestData);
    
    // Send request to backend for Excel generation and download
    fetch('/app/generate_fund_report_simple/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response received:', response);
        console.log('Response headers:', response.headers);
        
        // Check content type
        const contentType = response.headers.get('content-type');
        console.log('Content type:', contentType);
        
        if (contentType && contentType.includes('application/json')) {
            // Error response in JSON format
            return response.json().then(data => {
                throw new Error(data.message || 'Unknown error occurred');
            });
        } else if (response.ok) {
            // Success - return blob for Excel file
            return response.blob();
        } else {
            // Non-JSON error response
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
    })
    .then(blob => {
        console.log('Blob received:', blob);
        console.log('Blob type:', blob.type);
        console.log('Blob size:', blob.size);
        
        // Verify blob is valid
        if (blob.size === 0) {
            throw new Error('Received empty file from server');
        }
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Generate filename with .xlsx extension (NOT .xlsm)
        const safeFundName = fundName.replace(/[^a-zA-Z0-9\s\-_]/g, '').replace(/\s+/g, '_');
        const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `${safeFundName}_MF_Analysis_${currentDate}.xlsx`;  // Important: .xlsx extension
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Clean up
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
        }, 100);
        
        showAlert(`Excel report for "${fundName}" downloaded successfully!`, 'success');
        
        // Show summary
        const summaryText = `Generated report with ${selectedStocks.length} stocks and ${totalWeightage.toFixed(2)}% total weightage`;
        showAlert(summaryText, 'info');
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert(`Error generating Excel report: ${error.message}`, 'error');
    })
    .finally(() => {
        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // Reset button state
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    });
}
// Show alert function
function showAlert(message, type) {
    console.log('Showing alert:', message, type);
    
    try {
        const alertsContainer = document.getElementById('alerts');
        
        if (!alertsContainer) {
            console.error('Alerts container not found');
            return;
        }
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()">×</button>
        `;
        
        // Remove existing alerts of same type
        const existingAlerts = alertsContainer.querySelectorAll(`.alert-${type === 'error' ? 'danger' : type}`);
        existingAlerts.forEach(alert => alert.remove());
        
        alertsContainer.appendChild(alertDiv);
        
        // Auto remove after 5 seconds for success/info messages
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    } catch (error) {
        console.error('Error in showAlert function:', error);
        // Fallback alert
        alert(message);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing Fund Analysis...');
    
    try {
        // Check if elements exist
        const stockSelect = document.getElementById('stockSelect');
        const stocksTableBody = document.getElementById('stocksTableBody');
        const addStockBtn = document.getElementById('addStockBtn');
        
        console.log('Element check:', {
            stockSelect: !!stockSelect,
            stocksTableBody: !!stocksTableBody,
            addStockBtn: !!addStockBtn
        });
        
        if (!stockSelect) {
            console.error('stockSelect not found');
            return;
        }
        
        if (!stocksTableBody) {
            console.error('stocksTableBody not found');
            return;
        }
        
        console.log('Elements found successfully');
        console.log('Stocks in dropdown:', stockSelect.options.length - 1);
        
        // Test add stock button
        if (addStockBtn) {
            console.log('Add stock button found and ready');
        }
        
        // Initialize table
        updateTable();
        
        console.log('Fund Analysis initialized successfully');
        
    } catch (error) {
        console.error('Error during initialization:', error);
    }
});

// Test function to verify JavaScript is working
function testAddStock() {
    console.log('Test function called - JavaScript is working!');
    showAlert('JavaScript is working correctly!', 'success');
}

console.log('All functions defined successfully');
</script>

<style>
/* Form styling */
.form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Table styling */
.table th, .table td {
    vertical-align: middle;
}

/* Card styling */
.card {
    border: none;
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

/* Button styling */
.btn-outline-danger:hover {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545;
}

/* Alert styling */
.alert {
    border-radius: 8px;
    margin-bottom: 10px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
}

/* Make dropdown easier to use */
#stockSelect {
    height: 38px;
    font-size: 14px;
}

/* Highlight button on hover */
.btn-primary:hover, .btn-success:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Loading overlay */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.loading-content p {
    margin: 0;
    color: #666;
    font-size: 16px;
}
</style>
{% endblock %}