{% extends 'gcia_app/base.html' %}

{% block title %}Fund Analysis Metrics{% endblock %}

{% block content %}
    <!-- Update Metrics Button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Fund Analysis Metrics</h1>
        <button id="update-metrics-btn" class="btn btn-success">
            <i class="fas fa-calculator"></i> Update Metrics for MF
        </button>
    </div>

    <!-- Display Toast Notifications -->
    {% if messages %}
        <div id="toast-container">
            {% for message in messages %}
                <div class="toast {{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calculator"></i> Calculating Portfolio Metrics
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span><strong>Overall Progress</strong></span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="progress mb-3" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Current Fund:</strong><br>
                                <span id="current-fund" class="text-muted">-</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Current Stock:</strong><br>
                                <span id="current-stock" class="text-muted">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Progress:</strong>
                        <span id="processed-count">0</span> of <span id="total-count">0</span> funds processed
                    </div>

                    <div id="success-section" class="alert alert-success d-none">
                        <i class="fas fa-check-circle"></i>
                        <strong>Success!</strong> <span id="success-message">Portfolio metrics calculation completed successfully!</span>
                    </div>

                    <div id="error-section" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error:</strong> <span id="error-message"></span>
                    </div>

                    <div id="calculation-info" class="text-muted small">
                        <i class="fas fa-info-circle"></i>
                        This process calculates 22 portfolio analysis metrics for all underlying stocks across all available time periods.
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="close-progress-btn" class="btn btn-secondary" disabled>Close</button>
                    <button id="cancel-calculation-btn" class="btn btn-outline-danger" style="display: none;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Select a Fund for Analysis</h5>
            <p class="card-text">Choose a mutual fund from the dropdown below to download its portfolio analysis with integrated fund holdings and comprehensive stock financial metrics in the proper Portfolio Analysis format.</p>

            <form method="get" id="fund-selection-form">
                <div class="form-group mb-3">
                    <label for="fund-select" class="form-label">Select Fund:</label>
                    <select class="form-control" id="fund-select" name="selected_fund" required>
                        <option value="">-- Select a Fund --</option>
                        {% for fund in funds %}
                            <option value="{{ fund.amcfundscheme_id }}">{{ fund.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Exclusion Filters Section -->
                <div id="exclusion-filters" style="display: none;" class="mt-3">
                    <hr>
                    <h6 class="text-muted">Optional Filters (for Recalculated Analysis)</h6>

                    <!-- MarketCap Exclusion -->
                    <div class="form-group mb-3">
                        <label for="marketcap-exclude-select" class="form-label">
                            Exclude Market Cap:
                            <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip"
                               title="Only include stocks with MarketCap data from selected year onwards"></i>
                        </label>
                        <select class="form-control" id="marketcap-exclude-select">
                            <option value="">-- No Exclusion --</option>
                        </select>
                        <small class="form-text text-muted">
                            E.g., >2019 = Only stocks with MarketCap data from 2019 onwards
                        </small>
                    </div>

                    <!-- Holding Exclusion -->
                    <div class="form-group mb-3">
                        <label for="holding-exclude-select" class="form-label">
                            Exclude Holdings (Multi-select):
                            <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip"
                               title="Select holdings to exclude from recalculated analysis"></i>
                        </label>
                        <select class="form-control" id="holding-exclude-select" multiple size="6">
                        </select>
                        <small class="form-text text-muted">
                            Hold Ctrl/Cmd to select multiple. Selected holdings will be excluded.
                        </small>
                    </div>
                    <hr>
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="download-btn" disabled>Download Fund Metrics</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{% url 'home' %}'">Back to Home</button>
                </div>
            </form>

            <!-- Fund Information Display -->
            <div id="fund-info" class="mt-4" style="display: none;">
                <div class="alert alert-info">
                    <h6><strong>Selected Fund:</strong> <span id="selected-fund-name"></span></h6>
                    <p class="mb-0">Click "Download Fund Metrics" to get a Portfolio Analysis Excel file with integrated fund holdings data (weights, factor, value, shares) and comprehensive stock metrics in the correct format matching sample analysis reports.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information Card -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">About Fund Analysis Metrics</h5>
        </div>
        <div class="card-body">
            <p>The Portfolio Analysis report includes:</p>
            <ul>
                <li><strong>Integrated Fund Data:</strong> Company name, accord code, sector, cap classification with market cap, weights, factor, value, and shares</li>
                <li><strong>Financial Performance:</strong> Revenue and PAT data (6-year CAGR, TTM and quarterly periods)</li>
                <li><strong>Market Data:</strong> Market cap and free float data over 25+ time periods</li>
                <li><strong>Financial Ratios:</strong> ROCE, ROE, retention ratios over 12 financial years</li>
                <li><strong>Stock Pricing:</strong> Share prices and PE ratios over 10+ dates</li>
                <li><strong>Stock Identifiers:</strong> BSE codes, NSE symbols, and ISIN numbers</li>
                <li><strong>Portfolio Headers:</strong> Fund name, portfolio date, and proper 8-row header structure</li>
            </ul>
            <p class="text-muted">The exported Excel file follows the exact Portfolio Analysis format with 405 columns, matching the structure of professional fund analysis reports.</p>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fundSelect = document.getElementById('fund-select');
            const downloadBtn = document.getElementById('download-btn');
            const fundInfo = document.getElementById('fund-info');
            const selectedFundName = document.getElementById('selected-fund-name');

            console.log('Fund Analysis Metrics page loaded');
            console.log('Elements found:', {
                fundSelect: !!fundSelect,
                downloadBtn: !!downloadBtn,
                fundInfo: !!fundInfo,
                selectedFundName: !!selectedFundName
            });

            // Ensure button starts disabled
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.classList.remove('btn-primary');
                downloadBtn.classList.add('btn-secondary');
            }

            // Populate MarketCap years dropdown
            function populateMarketCapYears() {
                const select = document.getElementById('marketcap-exclude-select');
                const currentYear = new Date().getFullYear();
                const startYear = 2019;

                // Clear existing options (keep first one)
                while (select.options.length > 1) {
                    select.remove(1);
                }

                // Add year options
                for (let year = startYear; year <= currentYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.text = `>${year}`;
                    select.add(option);
                }
            }

            // Populate holdings dropdown via AJAX
            function populateHoldingsDropdown(schemeId) {
                const select = document.getElementById('holding-exclude-select');

                // Show loading
                select.innerHTML = '<option>Loading holdings...</option>';

                fetch(`/app/get_fund_holdings/${schemeId}/`)
                    .then(response => response.json())
                    .then(data => {
                        select.innerHTML = '';

                        if (data.success && data.holdings) {
                            data.holdings.forEach(holding => {
                                const option = document.createElement('option');
                                option.value = holding.id;
                                option.text = `${holding.company_name} (${holding.percentage}%)`;
                                select.add(option);
                            });
                        } else {
                            select.innerHTML = '<option>Error loading holdings</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching holdings:', error);
                        select.innerHTML = '<option>Error loading holdings</option>';
                    });
            }

            // Handle fund selection
            if (fundSelect) {
                fundSelect.addEventListener('change', function() {
                    console.log('Fund selection changed:', this.value);
                    const selectedValue = this.value;
                    const selectedText = this.options[this.selectedIndex].text;

                    if (selectedValue && selectedValue !== '') {
                        console.log('Enabling download button for fund:', selectedText);

                        // Enable download button
                        downloadBtn.disabled = false;
                        downloadBtn.classList.remove('btn-secondary');
                        downloadBtn.classList.add('btn-primary');
                        downloadBtn.style.cursor = 'pointer';

                        // Show fund info
                        if (selectedFundName) {
                            selectedFundName.textContent = selectedText;
                        }
                        if (fundInfo) {
                            fundInfo.style.display = 'block';
                        }

                        // Show exclusion filters
                        document.getElementById('exclusion-filters').style.display = 'block';

                        // Populate MarketCap years
                        populateMarketCapYears();

                        // Populate holdings via AJAX
                        populateHoldingsDropdown(selectedValue);

                    } else {
                        console.log('Disabling download button');

                        // Disable download button
                        downloadBtn.disabled = true;
                        downloadBtn.classList.remove('btn-primary');
                        downloadBtn.classList.add('btn-secondary');
                        downloadBtn.style.cursor = 'not-allowed';

                        // Hide fund info
                        if (fundInfo) {
                            fundInfo.style.display = 'none';
                        }

                        // Hide exclusion filters
                        document.getElementById('exclusion-filters').style.display = 'none';
                    }
                });
            }

            // Portfolio Metrics Calculation functionality
            const updateMetricsBtn = document.getElementById('update-metrics-btn');
            let currentSessionId = null;
            let progressInterval = null;

            // Handle Update Metrics button click
            if (updateMetricsBtn) {
                updateMetricsBtn.addEventListener('click', function() {
                    console.log('Update Metrics button clicked');

                    // Show modal
                    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                    progressModal.show();

                    // Reset progress display
                    resetProgressDisplay();

                    // Start calculation
                    startMetricsCalculation();
                });
            }

            function startMetricsCalculation() {
                fetch('{% url "trigger_metrics_calculation" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'limit_periods=' + encodeURIComponent('')
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Calculation response:', data);
                    if (data.success) {
                        currentSessionId = data.session_id;
                        startProgressPolling();
                    } else {
                        showError(data.error || 'Unknown error occurred');
                        enableCloseButton();
                    }
                })
                .catch(error => {
                    console.error('Calculation error:', error);
                    showError('Network error: ' + error.message);
                    enableCloseButton();
                });
            }

            function startProgressPolling() {
                console.log('Starting progress polling for session:', currentSessionId);
                progressInterval = setInterval(function() {
                    if (currentSessionId) {
                        fetch(`{% url "calculation_progress" "SESSION_ID" %}`.replace('SESSION_ID', currentSessionId))
                        .then(response => response.json())
                        .then(data => {
                            console.log('Progress data:', data);

                            if (data.error) {
                                showError(data.error);
                                stopProgressPolling();
                                enableCloseButton();
                                return;
                            }

                            updateProgressDisplay(
                                data.progress_percentage || 0,
                                data.current_fund_name || '-',
                                data.current_stock_name || '-',
                                data.processed_funds || 0,
                                data.total_funds || 0
                            );

                            if (data.status === 'completed') {
                                stopProgressPolling();
                                showSuccess('Portfolio metrics calculation completed successfully!');
                                enableCloseButton();
                            } else if (data.status === 'failed') {
                                stopProgressPolling();
                                showError(data.error_message || 'Calculation failed');
                                enableCloseButton();
                            }
                        })
                        .catch(error => {
                            console.error('Progress polling error:', error);
                        });
                    }
                }, 2000); // Poll every 2 seconds
            }

            function updateProgressDisplay(percentage, currentFund, currentStock, processed, total) {
                document.getElementById('progress-bar').style.width = percentage + '%';
                document.getElementById('progress-text').textContent = Math.round(percentage) + '%';
                document.getElementById('current-fund').textContent = currentFund;
                document.getElementById('current-stock').textContent = currentStock;
                document.getElementById('processed-count').textContent = processed;
                document.getElementById('total-count').textContent = total;
            }

            function resetProgressDisplay() {
                updateProgressDisplay(0, '-', '-', 0, 0);
                document.getElementById('success-section').classList.add('d-none');
                document.getElementById('error-section').classList.add('d-none');
                document.getElementById('close-progress-btn').disabled = true;
                document.getElementById('cancel-calculation-btn').style.display = 'inline-block';
            }

            function showError(message) {
                document.getElementById('error-message').textContent = message;
                document.getElementById('error-section').classList.remove('d-none');
                document.getElementById('cancel-calculation-btn').style.display = 'none';
            }

            function showSuccess(message) {
                document.getElementById('success-message').textContent = message;
                document.getElementById('success-section').classList.remove('d-none');
                document.getElementById('progress-text').textContent = '100% - Completed!';
                document.getElementById('current-fund').textContent = 'All funds processed';
                document.getElementById('current-stock').textContent = 'Calculation complete';
                document.getElementById('cancel-calculation-btn').style.display = 'none';
            }

            function stopProgressPolling() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }

            function enableCloseButton() {
                document.getElementById('close-progress-btn').disabled = false;
            }

            // Handle close button
            document.getElementById('close-progress-btn').addEventListener('click', function() {
                stopProgressPolling();
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (progressModal) {
                    progressModal.hide();
                }
            });

            // Handle cancel button
            document.getElementById('cancel-calculation-btn').addEventListener('click', function() {
                if (currentSessionId) {
                    fetch(`{% url "cancel_calculation" "SESSION_ID" %}`.replace('SESSION_ID', currentSessionId), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showError('Calculation cancelled by user');
                            stopProgressPolling();
                            enableCloseButton();
                        }
                    })
                    .catch(error => {
                        console.error('Cancel error:', error);
                    });
                }
            });

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Handle download button click
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Download button clicked');

                    const selectedFundId = fundSelect.value;
                    console.log('Selected fund ID:', selectedFundId);

                    if (!selectedFundId || selectedFundId === '') {
                        alert('Please select a fund first.');
                        return;
                    }

                    // Get exclusion parameters
                    const excludeMarketCap = document.getElementById('marketcap-exclude-select').value;
                    const excludeHoldingsSelect = document.getElementById('holding-exclude-select');
                    const excludeHoldings = Array.from(excludeHoldingsSelect.selectedOptions).map(opt => opt.value);

                    // Build download URL with parameters
                    let downloadUrl = "{% url 'download_fund_metrics' 0 %}".replace('0', selectedFundId);

                    const params = [];
                    if (excludeMarketCap) {
                        params.push(`exclude_marketcap=${excludeMarketCap}`);
                    }
                    if (excludeHoldings.length > 0) {
                        params.push(`exclude_holdings=${excludeHoldings.join(',')}`);
                    }

                    if (params.length > 0) {
                        downloadUrl += `?${params.join('&')}`;
                    }

                    console.log('Download URL with params:', downloadUrl);

                    // Show loading state
                    const originalText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating Excel...';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-info');

                    // Create a hidden link and click it to trigger download
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Reset button after a delay
                    setTimeout(() => {
                        this.disabled = false;
                        this.innerHTML = originalText;
                        this.classList.remove('btn-info');
                        this.classList.add('btn-primary');
                        console.log('Button reset');
                    }, 5000);  // 5 seconds for dual-sheet generation
                });
            }

            // Handle toast notifications
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(toast => {
                setTimeout(function() {
                    toast.classList.add('fade');
                }, 5000);

                setTimeout(function() {
                    toast.remove();
                }, 6000);
            });
        });
    </script>
{% endblock %}